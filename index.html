<!DOCTYPE html>
<html>
  <head>
    <title>Example JS</title>
    <link href="styles/style.css" type="text/css" rel="stylesheet"/>
  
    <!-- jQuery & Console -->
    <script src="scripts/jquery.js"></script>
    <script src="scripts/jquery.create.js"></script>
    <script src="scripts/beautifier.js"></script>
    <script src="scripts/console/prettyprint.js"></script>
    <script src="scripts/console/console.js"></script>    
    <script src="scripts/treeview.js"></script>

    <!-- EJS Compiler -->
    <script src="scripts/index.js"></script>
    <!-- OMeta -->
    <script src="scripts/ometa/base.js"></script>
    <!-- jsonml -->
    <script src="scripts/jsonml/jsonml_walker.js"></script>
    <script src="scripts/jsonml/node.js"></script>
    <!-- es5 -->
    <script src="scripts/es5/es5_nodes.js"></script>
    <script src="scripts/es5/es5_parser.js"></script>
    <script src="scripts/es5/es5_translator.js"></script>
    <!-- ejs -->    
    <script src="scripts/ejs/ejs_nodes.js"></script>
    <script src="scripts/ejs/ejs_parser.js"></script>
    <script src="scripts/ejs/ejs_translator.js"></script>
    <script src="scripts/ejs/ejs_runtime.js"></script>

    <script>
      $(function() {
  
        function unescape(str) {
          return str.replace(/\&\w+;/, function(m) {
            return {
              "&lt;"  : '<',
              "&gt;"  : '>',
              "&amp;" : '&'
            }[m]
          })
        }

        var input         = $('#input'),
            jscode        = $('#jscode'),            
            button        = $('#eval'),
            last_compiled = "",
            tree          = Treeview('#treeview'),
            cons          = new Console('#console');

        input.keyup(function(evt) {
    
          if(input.val() == last_compiled) return true;

          last_compiled = input.val();

          try {
            var ejs_tree = ejs.EJSParser.parse(input.val()),
                es5_tree = ejs.EJSTranslator.translate(ejs_tree),
                es5_code = es5.ES5Translator.translate(es5_tree),
                beauty   = js_beautify(es5_code, { indent_size: 2, space_before_conditional: false });
            jscode.html(beauty);
            tree.show(es5_tree);
            
          } catch(e) { /* ignore */ console.error(e) }

        }).focus(function() {
          input.parent('div').addClass('focus');

        }).blur(function() {
          input.parent('div').removeClass('focus');
        })

        button.click(function() {
          input.trigger('keyup');
          (function(console) {
            try {
              eval(unescape(jscode.html()));
            } catch(e) { console.error(e) }
          })(cons);
          var height = 0;
          return false;
        });

        $(window).keydown(function(evt) {
          if(evt.keyCode == 13 && evt.ctrlKey)
            button.trigger('click');
        });

        $('.switch a').click(function(evt) {
          var el = $(this);
          el.parent('li').addClass('active').siblings('li').removeClass('active');
          $(el.attr('href')).removeClass('hidden').siblings().addClass('hidden');
          return false;
        });        
        
      });

    </script>
  </head>
  <body>
    <header>
      <h1>Example JS</h1>
      <nav>
        <a href="http://github.com/b-studios/ejs">Project Page</a>
      </nav>
    </header>
    <div id="wrapper">
      <div id="before-compilation">
        <textarea id="input">console.log("Hello World");</textarea>
      </div>      
      <div id="after-compilation">
        <ul class="switch">
          <li class="code active"><a href="#jscode"></a></li>
          <li class="tree"><a href="#treeview"></a></li>
        </ul>
        <output id="jscode"></output>
        <ul id="treeview" class="hidden"></ul>
      </div>
      <div id="after-evaluation">
        <ul id="console"></ul>
        <button id="eval" title="Ctrl + Return">Execute</button>
      </div>
    </div>
  </body>
</html>
